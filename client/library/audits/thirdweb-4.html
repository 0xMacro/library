<page
  clientName="thirdweb"
  reportDate="September 29th, 2022"
  auditTitle="thirdweb A-4"
  auditVersion="1.0.0"
  repoUrl="https://github.com/thirdweb-dev/contracts"
  customRepoInfo
  appendixLinks="#appendix-review::Review Notes on VoteERC20.sol and Split.sol"

  layout="/library/audits/_layout.html"
>

<content-for name="schedule">
  The security audit was performed by the Macro security team from August 23, 2022 to September 2, 2022.
</content-for>

<content-for name="spec">
  <ul>
    <li>Discussions on Slack with the thirdweb team.</li>
    <li>
      The official <a href="https://thirdweb.com/" target="_blank">website</a>, <a href="https://portal.thirdweb.com/" target="_blank">developer documentation</a> and more specifically provided documentation for contracts which were in scope of the performed audit: <a href="https://github.com/thirdweb-dev/contracts/blob/v3.1.1/contracts/token/signatureMint.md" target="_blank">SignatureMint</a>.
    </li>
  </ul>
</content-for>


<content-for name="repo-info">
  <ul>
    <li>
      <b>Repository:</b>
      <a href="{{page.repoUrl}}" target="_blank">
        {{page.repoUrl.split('/').slice(-1)[0]}}
      </a>
    </li>
    <li class="break-words break-all">
      <b>Commit Hash:</b>
      <code>d3f61abc34d930788e09b968affb38fec5762408</code>
    </li>
  </ul>
</content-for>


<content-for name="source-code">

  <p>Specifically, we audited the following contracts as part of TokenERC20 contract audit:</p>

  <template type="file-hashes">
    b60f119b198c65147fdd0dfa1db2edacf5018abc0a7600707773bef8a029ee57  contracts/token/TokenERC20.sol
    3d2ede585eb7e37872a0f3566a143f5b2aa586873160966d34c98963015f622d  contracts/lib/FeeType.sol
    ab7e40d1b333d675e23d9d4a4c70836c508b2e8b890cf1c6f3dc554424d1215d  contracts/lib/CurrencyTransferLib.sol
    4ef0ce1601048c10a4b0fdc3247062be8f1a9ca0441c862ddfadc16251a31edb  contracts/openzeppelin-presets/metatx/ERC2771ContextUpgradeable.sol
    6765deea0f732abce9f6b450826da733d59ad101b1bab9014a408a5098e54105  contracts/extension/interface/IPlatformFee.sol
    923135d5e6d6ea2452ccdecbe4794b48fbe4389231caa78fba964a1d4ba4114f  contracts/extension/interface/IPrimarySale.sol
    a6160110711cb0935a9b23d2d0429fa54237ec8bdf5ae7d19b328dd39c93ac45  contracts/interfaces/token/ITokenERC20.sol
    4c57ef2e5572551ee29ec7ecfcb67932f152f7b0ffd1e5c84e0976f577eb43c5  contracts/interfaces/ITWFee.sol
    8fc9d29ddee99b052ccdc521c272ee4df8a7de0e1754bfcba397dc5cdfa18c72  contracts/interfaces/IThirdwebContract.sol
  </template>


  <p>We audited the following contracts as part of TokenERC721 contract audit:</p>

  <template type="file-hashes">
    01266703a6d26dbc1e223115dd4476b87d9adb8ab0ac9676718b6c8265a33eb3  contracts/token/TokenERC721.sol
    3d2ede585eb7e37872a0f3566a143f5b2aa586873160966d34c98963015f622d  contracts/lib/FeeType.sol
    ab7e40d1b333d675e23d9d4a4c70836c508b2e8b890cf1c6f3dc554424d1215d  contracts/lib/CurrencyTransferLib.sol
    4ef0ce1601048c10a4b0fdc3247062be8f1a9ca0441c862ddfadc16251a31edb  contracts/openzeppelin-presets/metatx/ERC2771ContextUpgradeable.sol
    6765deea0f732abce9f6b450826da733d59ad101b1bab9014a408a5098e54105  contracts/extension/interface/IPlatformFee.sol
    923135d5e6d6ea2452ccdecbe4794b48fbe4389231caa78fba964a1d4ba4114f  contracts/extension/interface/IPrimarySale.sol
    8f39cbdfd7fff348f5f002c2ee87f607811e02312a673781e1cd3281694a9568  contracts/extension/interface/IRoyalty.sol
    f4e6814d6fa45c709cbd03de2a2fd46fb86d3156cb934f6feb9acaa692deca72  contracts/extension/interface/IOwnable.sol
    f472020a23d63126b70ddbd2db87d12bdcd2a0765e8ab4e013344794b1fcc7f0  contracts/interfaces/token/ITokenERC721.sol
    4c57ef2e5572551ee29ec7ecfcb67932f152f7b0ffd1e5c84e0976f577eb43c5  contracts/interfaces/ITWFee.sol
    8fc9d29ddee99b052ccdc521c272ee4df8a7de0e1754bfcba397dc5cdfa18c72  contracts/interfaces/IThirdwebContract.sol
  </template>


  <p>We audited the following contracts as part of TokenERC1155 contract audit:</p>

  <template type="file-hashes">
    68d480bcdc3b470ad4049addbc07e6e08e8800a7449f4b198a8d7301dc1c1f23  contracts/token/TokenERC1155.sol
    3d2ede585eb7e37872a0f3566a143f5b2aa586873160966d34c98963015f622d  contracts/lib/FeeType.sol
    ab7e40d1b333d675e23d9d4a4c70836c508b2e8b890cf1c6f3dc554424d1215d  contracts/lib/CurrencyTransferLib.sol
    4ef0ce1601048c10a4b0fdc3247062be8f1a9ca0441c862ddfadc16251a31edb  contracts/openzeppelin-presets/metatx/ERC2771ContextUpgradeable.sol
    6765deea0f732abce9f6b450826da733d59ad101b1bab9014a408a5098e54105  contracts/extension/interface/IPlatformFee.sol
    923135d5e6d6ea2452ccdecbe4794b48fbe4389231caa78fba964a1d4ba4114f  contracts/extension/interface/IPrimarySale.sol
    8f39cbdfd7fff348f5f002c2ee87f607811e02312a673781e1cd3281694a9568  contracts/extension/interface/IRoyalty.sol
    f4e6814d6fa45c709cbd03de2a2fd46fb86d3156cb934f6feb9acaa692deca72  contracts/extension/interface/IOwnable.sol
    fc20fdff4ab4db1ddf2849e4309c2e2239a147fd0ef6fe49130494af902aa0d0  contracts/interfaces/token/ITokenERC1155.sol
    4c57ef2e5572551ee29ec7ecfcb67932f152f7b0ffd1e5c84e0976f577eb43c5  contracts/interfaces/ITWFee.sol
    8fc9d29ddee99b052ccdc521c272ee4df8a7de0e1754bfcba397dc5cdfa18c72  contracts/interfaces/IThirdwebContract.sol
  </template>
</content-for>

<content-for name="appendix">
  <section id="appendix-review" class="Copy py-16">
    <template type="audit-markdown">
      ## Review Notes on VoteERC20.sol and Split.sol

      **Scope:** VoteERC20.sol and Split.sol

      For these two contracts, we opted to do a review instead of a full audit, due there being no test suite and low documentation. However, we were happy to provide suggestions and considerations in this way.

      ## VoteERC20.sol

      ### (1) Both `proposalIndex` and `proposalId` are used

      **Resolution**: Wont Do.

      The two common options to store proposals on-chain in DAO proposal systems are:

      1. Store all function calls and arguments on-chain.
      2. Store a 32 byte hash of all function calls on-chain, and post the source of that hash off-chain (e.g. on a public forum).

      The former leans more towards decentralization, as anyone can read on-chain data to verify the proposed function calls at any time.

      On the other hand, the latter saves on gas costs, as storing function calls on-chain can get expensive.

      *VoteERC20* takes the approach of both:

      1. It uses Open Zeppelin’s [GovernorUpgradeable](https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/blob/master/contracts/governance/GovernorUpgradeable.sol#L262) contract, which uses approach #2.
      2. It extends `propose()` to store all calls in its own proposals variable (approach #1), including the 32 byte hash from the parent OZ contract.

      Doing both is redundant, which will result in increased gas costs for no benefit. It may also cause confusion, as there are arguably two ids: the 32 byte hash, and the proposal index.

      Consider taking one approach or another. If approach #1 is desired, consider using Compound’s Governor Bravo contracts. Otherwise, it may be sufficient that the proposed function calls are [emitted in an event](https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/blob/master/contracts/governance/GovernorUpgradeable.sol#L277-L287).

      ## Split.sol

      ### (1) DoS vulnerability in `distribute` function

      **Resolution**: Wont Do.

      In *Split* contract, `distribute` function loops through each payee address and sends assets performing checks and reverting if any of these calls fails. If one of the payees reverts the transfer the entire `distribute` function will revert in every call. This can also be intentionally done by a smart contract address as a payee.

      The vulnerability is not that bad, since anyone is able to call `release()` for their own account at any time. However, consider documenting the dangers 3rd party contracts or other thirdweb contracts relying on this function.

      Also consider not reverting on failed transfers, if atomicity is not important.

      ### (2) OpenZeppelin’s version of PaymentSplitterUpgradeable.sol has been updated

      **Resolution**: Updated preset version to reflect OZ changes.

      Split contract inherits from `PaymentSplitterUpgradeable`.  It is not referencing the OpenZeppelin version directly but instead is using a preset version:

      ```solidity
      import "./openzeppelin-presets/finance/PaymentSplitterUpgradeable.sol";
      ```

      OpenZeppelin did some slight changes recently on this contract and has added `releasable` functions. See here: [https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/commit/b392c249e2c72434c438e0e495af1bacbc6cfd4f#diff-ec6a964c766447336ea6842ff3214ac85da5144ccf44d92e100d3d4acfd907c4](https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/commit/b392c249e2c72434c438e0e495af1bacbc6cfd4f#diff-ec6a964c766447336ea6842ff3214ac85da5144ccf44d92e100d3d4acfd907c4)

      Consider to update the preset version to include those latest changes, as `releasable()` is a useful function.

      ### (3) Inconsistent zero check

      **Resolution**: The ThirdWeb fee was removed.

      After calling `thirdwebFee.getFeeInfo()`, the Split contract checks to see if their values are not equal to zero. This seems to be inconsistent with the rest of the codebase.

      If this check is important, consider reevaluating other parts of the codebase that do not have this check.

      ### (4) Inaccurate comments

      **Resolution**: Removed related comments.

      On `distribute` function, *Split* contract has comments referring to an function named `_appPay` but it does not seem to exist in the codebase.

      ```solidity
      function distribute() public virtual {
          uint256 count = payeeCount();
          for (uint256 i = 0; i < count; i++) {
              ****// note: `_release` should not fail because payee always has shares, **protected by `_appPay`**
              _release(payable(payee(i)));
          }
      }

      function distribute(IERC20Upgradeable token) public virtual {
          uint256 count = payeeCount();
          for (uint256 i = 0; i < count; i++) {
              ****// note: `_release` should not fail because payee always has shares, **protected by `_appPay**`
              _release(token, payee(i));
          }
      }
      ```
    </template>
  </section>
</content-for>
